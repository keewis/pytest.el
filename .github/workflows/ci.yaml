name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: setup emacs
        uses: purcell/setup-emacs@master
        with:
          version: 26.1

      - name: install dependencies
        run: |
          export archives='(("melpa" . "https://melpa.org/packages/")
                            ("elpa" . "https://elpa.gnu.org/packages/"))'
          export packages="(s projectile cl)"
          echo "y" | emacs -batch -Q \
            --eval "(package-initialize)" \
            --eval "(setq package-archives '$archives)" \
            --eval "(package-refresh-contents)" \
            --eval "(setq package-selected-packages '$packages)" \
            --eval "(package-install-selected-packages)"

      - name: run tests
        run: |
          export test_files=$(find tests -name "*.el" | while read x; do echo -n " -l $(basename $x)"; done)
          emacs -batch -Q --eval "(package-initialize)" -l ert -L lisp -L tests $test_files -f ert-run-tests-batch-and-exit

  docs:
    name: Docs
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: upgrade pip
        run: python -m pip install -U pip setuptools

      - name: install sphinx
        run: python -m pip install sphinx sphinx_rtd_theme

      - name: build
        run: |
          cd doc
          python -m sphinx -M html -d _build/doctrees -Ea -WT --keep-going -n . _build/html
